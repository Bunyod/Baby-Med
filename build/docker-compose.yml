version: '3.9'
services:
  babymed_services-users:
    restart: always
    image: babymed/services-users:latest
    container_name: babymed_services-users
    environment:
      APP_MODE: ${APP_MODE}
      USERS_RPC_PORT: ${USERS_RPC_PORT}
      USERS_HTTP_PORT: ${USERS_HTTP_PORT}
      HTTP_HEADER_LOG: ${HTTP_HEADER_LOG}
      HTTP_BODY_LOG: ${HTTP_BODY_LOG}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE}
      POSTGRES_POOL_SIZE: ${POSTGRES_POOL_SIZE}
    networks:
      - external-net
    logging:
      driver: "fluentd"
      options:
        fluentd-address: fluentd:24224
        fluentd-async-connect: "true"
        fluentd-retry-wait: 1s
        fluentd-max-retries: 30
        tag: babymed

  babymed_services-payments:
    restart: always
    image: babymed/services-payments:latest
    container_name: babymed_services-payments
    environment:
      APP_MODE: ${APP_MODE}
      PAYMENTS_RPC_PORT: ${PAYMENTS_RPC_PORT}
      PAYMENTS_HTTP_PORT: ${PAYMENTS_HTTP_PORT}
      HTTP_HEADER_LOG: ${HTTP_HEADER_LOG}
      HTTP_BODY_LOG: ${HTTP_BODY_LOG}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE}
      POSTGRES_POOL_SIZE: ${POSTGRES_POOL_SIZE}
    networks:
      - external-net
    logging:
      driver: "fluentd"
      options:
        fluentd-address: fluentd:24224
        fluentd-async-connect: "true"
        fluentd-retry-wait: 1s
        fluentd-max-retries: 30
        tag: babymed

  babymed_services-babymed-api:
    restart: always
    image: babymed/services-babymed-api:latest
    container_name: babymed_services-babymed-api
    environment:
      APP_MODE: ${APP_MODE}
      USERS_RPC_HOST: babymed_services-users
      USERS_RPC_PORT: ${USERS_RPC_PORT}
      PAYMENTS_RPC_HOST: babymed_services-payments
      PAYMENTS_RPC_PORT: ${PAYMENTS_RPC_PORT}
      HTTP_HEADER_LOG: ${HTTP_HEADER_LOG}
      HTTP_BODY_LOG: ${HTTP_BODY_LOG}
      BABYMED_API_HTTP_PORT: 9000
      ACCESS_TOKEN_SECRET_KEY: dah3EeJ8xohtaeJ5ahyah-
      JWT_TOKEN_EXPIRATION: 15.minutes
      REDIS_SERVER_URI: redis://redis

    networks:
      - external-net
    logging:
      driver: "fluentd"
      options:
        fluentd-address: fluentd:24224
        fluentd-async-connect: "true"
        fluentd-retry-wait: 1s
        fluentd-max-retries: 30
        tag: babymed

networks:
  external-net:
    driver: bridge
    external:
      name: external-net